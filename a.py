import streamlit as st
import pandas as pd
import plotly.express as px

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
st.set_page_config(page_title="Industrial Factory Dashboard", layout="wide")

st.title("üè≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó 101, 105, 106)")
st.markdown("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö Interactive")

# 1. ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
uploaded_file = st.file_uploader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .CSV ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", type=["csv"])

if uploaded_file is not None:
    # ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    df = pd.read_csv(uploaded_file)
    
    # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
    df['‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)'] = pd.to_numeric(df['‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)'], errors='coerce')
    df['‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°'] = pd.to_numeric(df['‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°'], errors='coerce')

    # --- 5. ‡∏™‡πà‡∏ß‡∏ô Filter ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    st.sidebar.header("üîç ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
    
    selected_province = st.sidebar.multiselect(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:", options=df["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"].unique(), default=df["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"].unique()[:5]
    )
    
    selected_type = st.sidebar.multiselect(
        "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô:", options=df["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô"].unique(), default=df["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô"].unique()
    )

    # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    mask = (df["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"].isin(selected_province)) & (df["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô"].isin(selected_type))
    filtered_df = df[mask]

    # --- 1 & 4. ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü ---
    
    # ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (KPI Cards)
    col1, col2, col3 = st.columns(3)
    col1.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", f"{len(filtered_df):,.0f} ‡πÅ‡∏´‡πà‡∏á")
    col2.metric("‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)", f"{filtered_df['‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)'].sum():,.2f}")
    col3.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°", f"{filtered_df['‡∏Ñ‡∏ô‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°'].sum():,.0f} ‡∏Ñ‡∏ô")

    st.divider()

    # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡∏û‡∏£‡πâ‡∏≠‡∏° Data Labels)
    c1, c2 = st.columns(2)
    
    with c1:
        st.subheader("üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î")
        fig_bar = px.bar(
            filtered_df.groupby("‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î").size().reset_index(name='count').sort_values(by='count', ascending=False),
            x="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", y="count",
            text_auto=True, # ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡πÅ‡∏ó‡πà‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            color="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î",
            labels={'count': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô'}
        )
        st.plotly_chart(fig_bar, use_container_width=True)

    with c2:
        st.subheader("üçï ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô")
        fig_pie = px.pie(
            filtered_df, names="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô",
            hole=0.4
        )
        fig_pie.update_traces(textposition='inside', textinfo='percent+label') # ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô %
        st.plotly_chart(fig_pie, use_container_width=True)

    # --- 6. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
    st.subheader("üìë ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö")
    st.dataframe(filtered_df, use_container_width=True)

else:
    st.info("üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")