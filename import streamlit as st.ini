import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
import plotly.express as px

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
st.set_page_config(page_title="Factory Dashboard", layout="wide")

st.title("üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏è‡∏¥‡∏Å‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß")

# 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets (‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡πÑ‡∏ü‡∏•‡πå 1a.csv ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Ñ‡∏µ‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ)
conn = st.connection("gsheets", type=GSheetsConnection)
df = conn.read()

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Ç‡πâ‡∏≠ 2: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) ---
with st.expander("‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà"):
    with st.form("factory_form"):
        name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô")
        province = st.selectbox("‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ"])
        capital = st.number_input("‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)")
        submit = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å")
        
        if submit:
            new_row = pd.DataFrame([{"‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô": name, "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î": province, "‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)": capital}])
            df = pd.concat([df, new_row], ignore_index=True)
            conn.update(data=df)
            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: Dashboard (‡∏Ç‡πâ‡∏≠ 1, 4, 5) ---
# ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (Filter - ‡∏Ç‡πâ‡∏≠ 5)
st.sidebar.header("‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á")
selected_prov = st.sidebar.multiselect("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", options=df["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"].unique(), default=df["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"].unique())
filtered_df = df[df["‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"].isin(selected_prov)]

col1, col2 = st.columns(2)
with col1:
    # ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏Ç‡πâ‡∏≠ 4)
    st.subheader("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î")
    fig = px.bar(filtered_df, x="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", text_auto=True) # text_auto ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô‡πÅ‡∏ó‡πà‡∏á
    st.plotly_chart(fig, use_container_width=True)

with col2:
    # ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (‡∏Ç‡πâ‡∏≠ 4)
    st.subheader("‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô")
    fig_pie = px.pie(filtered_df, values="‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏° (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)", names="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î")
    st.plotly_chart(fig_pie, use_container_width=True)

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Ç‡πâ‡∏≠ 6) ---
st.subheader("üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
st.dataframe(filtered_df, use_container_width=True)